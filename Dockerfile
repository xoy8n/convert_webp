# Generated by https://smithery.ai. See: https://smithery.ai/docs/config#dockerfile
# syntax=docker/dockerfile:1.4

# Builder stage
FROM node:lts-alpine AS builder

# Install build dependencies for sharp
RUN apk add --no-cache \
    build-base \
    python3 \
    vips-dev \
    fftw-dev \
    libjpeg-turbo-dev \
    libpng-dev \
    libwebp-dev \
    tiff-dev \
    giflib-dev

WORKDIR /app

# Copy project files
COPY package.json package-lock.json tsconfig.json ./

# Install dependencies
RUN npm ci

# Copy source code and build
COPY src ./src
RUN npm run build

# Production stage
FROM node:lts-alpine AS production

# Install runtime dependencies for sharp
RUN apk add --no-cache \
    vips \
    fftw \
    libjpeg-turbo \
    libpng \
    libwebp \
    tiff \
    giflib

WORKDIR /app

# Copy package manifests
COPY package.json package-lock.json ./

# Install only production dependencies
RUN npm ci --only=production

# Copy built application
COPY --from=builder /app/dist ./dist

# Use unprivileged user (optional)
# RUN addgroup -S app && adduser -S -G app app
# USER app

# Default command to start the MCP server
CMD ["node", "dist/index.js"]
