# Generated by https://smithery.ai. See: https://smithery.ai/docs/config#dockerfile
# Multi-stage Dockerfile for building and running the WebP MCP server

# Stage 1: Build
FROM node:lts-alpine AS builder

# Install dependencies for sharp
RUN apk add --no-cache vips-dev fftw-dev build-base python3

WORKDIR /app

# Copy project files
COPY package.json package-lock.json tsconfig.json ./
COPY src ./src

# Install all dependencies including devDependencies for build
RUN npm ci

# Build TypeScript
RUN npm run build

# Stage 2: Runtime
FROM node:lts-alpine

# Install runtime dependency for sharp
RUN apk add --no-cache vips-dev fftw-dev

WORKDIR /app

# Copy compiled files and production dependencies
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/package-lock.json ./package-lock.json

# Install production deps only
RUN npm ci --only=production

# Default allowed directory
ENV ALLOWED_DIR=/data

# Start the MCP server
CMD ["node", "dist/index.js"]
